# Credit & Paid Amount åŠŸèƒ½å‡çº§ - ç®€åŒ–å®æ–½è®¡åˆ’

> ğŸ’¡ **è®¾è®¡åŸåˆ™**: å¤Ÿç”¨å°±å¥½,å•äººä½¿ç”¨,å…è´¹ Render éƒ¨ç½²

## æ ¸å¿ƒç›®æ ‡

æ·»åŠ  2 ä¸ªå­—æ®µ,æ”¯æŒ:
1. **Credit** - è®°å½•é€€æ¬¾æŠµæ‰£
2. **Paid Amount** - è®°å½•å®é™…ä»˜æ¬¾(æ”¯æŒåˆ†æœŸ)

**éƒ¨ç½²è¦æ±‚**: `git push` â†’ Render è‡ªåŠ¨éƒ¨ç½² â†’ æ•°æ®åº“è‡ªåŠ¨æ›´æ–° âœ…

---

## 3 æ­¥å®æ–½

### ç¬¬ 1 æ­¥: æ•°æ®åº“ (æœ€é‡è¦)

**ä¿®æ”¹ `database.py`**:
1. åœ¨ `Invoice` æ¨¡å‹æ·»åŠ  2 ä¸ªå­—æ®µ
2. åœ¨ Supabase DDL æ·»åŠ å­—æ®µå®šä¹‰
3. å®ç°è‡ªåŠ¨è¿ç§»(æ£€æµ‹ç¼ºå¤±å­—æ®µå¹¶è‡ªåŠ¨æ·»åŠ )

### ç¬¬ 2 æ­¥: åç«¯é€»è¾‘

**ä¿®æ”¹ `app.py`**:
1. `/upload` è·¯ç”±æ¥æ”¶ `credit` å‚æ•°
2. `/upload_payment` è·¯ç”±æ¥æ”¶ `paidAmount`,ç´¯åŠ åˆ° `paid_amount`
3. æ·»åŠ ç®€å•çš„è®¡ç®—å‡½æ•°(å‰©ä½™é‡‘é¢ã€ä»˜æ¬¾çŠ¶æ€)

### ç¬¬ 3 æ­¥: å‰ç«¯ç•Œé¢

**ä¿®æ”¹ 3 ä¸ªæ¨¡æ¿**:
1. `upload.html` - æ·»åŠ  Credit è¾“å…¥æ¡†
2. `edit.html` - æ·»åŠ  Paid Amount è¾“å…¥æ¡†
3. `index.html` - æ˜¾ç¤ºæ–°å­—æ®µ

---

## å®æ–½é˜¶æ®µ

### é˜¶æ®µ 1: æ•°æ®åº“å±‚å‡çº§ (æ ¸å¿ƒ)

#### 1.1 ä¿®æ”¹ `database.py` - Invoice æ¨¡å‹

**æ–‡ä»¶**: [database.py](file:///c:/Users/zhi89/Desktop/invos/database.py)

**å˜æ›´å†…å®¹**:
```python
class Invoice(Base):
    __tablename__ = "invoices"
    
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢å­—æ®µ
    credit = Column(Float, nullable=False, default=0.00)
    paid_amount = Column(Float, nullable=False, default=0.00)
```

**ä½ç½®**: ç¬¬ 14-28 è¡Œé™„è¿‘

---

#### 1.2 ä¿®æ”¹ `database.py` - SQLiteBackend._to_dict()

**å˜æ›´å†…å®¹**:
```python
@staticmethod
def _to_dict(invoice: Invoice) -> Dict[str, Any]:
    return {
        # ... ç°æœ‰å­—æ®µ ...
        "credit": invoice.credit,  # æ–°å¢
        "paid_amount": invoice.paid_amount,  # æ–°å¢
    }
```

**ä½ç½®**: ç¬¬ 130-144 è¡Œ

---

#### 1.3 ä¿®æ”¹ `database.py` - SupabaseBackend DDL

**å˜æ›´å†…å®¹**:
```python
ddl = """
create table if not exists public.invoices (
    id bigint generated by default as identity primary key,
    -- ... ç°æœ‰å­—æ®µ ...
    credit numeric default 0.00 not null,  -- æ–°å¢
    paid_amount numeric default 0.00 not null,  -- æ–°å¢
    inserted_at timestamp with time zone default now()
);
"""
```

**ä½ç½®**: ç¬¬ 223-238 è¡Œ

---

#### 1.4 å®ç°è‡ªåŠ¨è¿ç§»æœºåˆ¶ â­ (æœ€é‡è¦)

**æ–‡ä»¶**: [database.py](file:///c:/Users/zhi89/Desktop/invos/database.py)

**æ–°å¢æ–¹æ³•**: `SupabaseBackend._auto_migrate_fields()`

**å®ç°é€»è¾‘**:
```python
def _auto_migrate_fields(self, conn) -> None:
    """è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ ç¼ºå¤±çš„å­—æ®µ"""
    
    # 1. æŸ¥è¯¢ç°æœ‰å­—æ®µ
    cursor = conn.execute("""
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'invoices' AND table_schema = 'public'
    """)
    existing_columns = {row[0] for row in cursor.fetchall()}
    
    # 2. å®šä¹‰æœŸæœ›å­—æ®µ
    required_fields = {
        'credit': 'numeric default 0.00 not null',
        'paid_amount': 'numeric default 0.00 not null'
    }
    
    # 3. æ·»åŠ ç¼ºå¤±å­—æ®µ
    for field_name, field_def in required_fields.items():
        if field_name not in existing_columns:
            conn.execute(f"""
                ALTER TABLE public.invoices 
                ADD COLUMN {field_name} {field_def}
            """)
            
            # 4. ä¸ºç°æœ‰æ•°æ®è®¾ç½®é»˜è®¤å€¼
            if field_name == 'paid_amount':
                # å·²ä»˜æ¬¾çš„å‘ç¥¨,è®¾ç½® paid_amount = total_amount
                conn.execute("""
                    UPDATE public.invoices 
                    SET paid_amount = total_amount 
                    WHERE payment_status = 'paid' AND paid_amount = 0
                """)
            elif field_name == 'credit':
                # æ‰€æœ‰ç°æœ‰è®°å½•çš„ credit è®¾ä¸º 0.00
                conn.execute("""
                    UPDATE public.invoices 
                    SET credit = 0.00 
                    WHERE credit IS NULL
                """)
```

**è°ƒç”¨ä½ç½®**: åœ¨ `_ensure_table_exists()` æ–¹æ³•æœ«å°¾è°ƒç”¨

---

### é˜¶æ®µ 2: ä¸šåŠ¡é€»è¾‘å±‚å‡çº§

#### 2.1 ä¿®æ”¹ `app.py` - å‘ç¥¨ä¸Šä¼ è·¯ç”±

**æ–‡ä»¶**: [app.py](file:///c:/Users/zhi89/Desktop/invos/app.py)

**è·¯ç”±**: `/upload` (POST)

**å˜æ›´å†…å®¹**:
```python
@app.route('/upload', methods=['GET', 'POST'])
def upload():
    if request.method == 'POST':
        # ... ç°æœ‰å­—æ®µè·å– ...
        
        # æ–°å¢: è·å– credit å­—æ®µ
        credit_raw = request.form.get('credit', '0.00')
        try:
            credit = float(credit_raw.replace(',', ''))
            if credit < 0:
                flash("Credit amount cannot be negative.", 'danger')
                return redirect(url_for('upload'))
        except (TypeError, ValueError):
            credit = 0.00
        
        invoice_record = {
            # ... ç°æœ‰å­—æ®µ ...
            "credit": credit,  # æ–°å¢
            "paid_amount": 0.00,  # æ–°å¢: åˆå§‹åŒ–ä¸º 0
        }
```

**ä½ç½®**: ç¬¬ 220-298 è¡Œ

---

#### 2.2 ä¿®æ”¹ `app.py` - ä»˜æ¬¾ç¡®è®¤è·¯ç”±

**æ–‡ä»¶**: [app.py](file:///c:/Users/zhi89/Desktop/invos/app.py)

**è·¯ç”±**: `/upload_payment/<invoice_id>` (POST)

**å˜æ›´å†…å®¹**:
```python
@app.route('/upload_payment/<int:invoice_id>', methods=['POST'])
def upload_payment_proof(invoice_id: int):
    payment_date = request.form.get('paymentDate')
    
    # æ–°å¢: è·å– paid_amount
    paid_amount_raw = request.form.get('paidAmount')
    if not paid_amount_raw:
        flash("Paid amount is required.", 'danger')
        return redirect(url_for('edit_invoice', invoice_id=invoice_id))
    
    try:
        paid_amount = float(paid_amount_raw.replace(',', ''))
        if paid_amount < 0:
            flash("Paid amount cannot be negative.", 'danger')
            return redirect(url_for('edit_invoice', invoice_id=invoice_id))
    except (TypeError, ValueError):
        flash("Paid amount must be a number.", 'danger')
        return redirect(url_for('edit_invoice', invoice_id=invoice_id))
    
    # è¯»å–å½“å‰å‘ç¥¨
    invoices = database.get_invoices()
    invoice = next((inv for inv in invoices if inv['id'] == invoice_id), None)
    if not invoice:
        flash("Invoice not found.", 'danger')
        return redirect(url_for('index'))
    
    # ç´¯åŠ ä»˜æ¬¾é‡‘é¢
    current_paid = invoice.get('paid_amount', 0.00)
    new_paid_amount = current_paid + paid_amount
    
    # éªŒè¯ä¸è¶…è¿‡æ€»é‡‘é¢
    if new_paid_amount > invoice['total_amount']:
        flash(f"Total paid amount (${new_paid_amount:.2f}) cannot exceed total amount (${invoice['total_amount']:.2f}).", 'danger')
        return redirect(url_for('edit_invoice', invoice_id=invoice_id))
    
    # è®¡ç®—ä»˜æ¬¾çŠ¶æ€
    if new_paid_amount >= invoice['total_amount']:
        payment_status = 'paid'
    elif new_paid_amount > 0:
        payment_status = 'partial'
    else:
        payment_status = 'unpaid'
    
    # ... æ–‡ä»¶ä¸Šä¼ é€»è¾‘ ...
    
    update_data = {
        "payment_status": payment_status,
        "paid_amount": new_paid_amount,  # æ–°å¢
        "payment_proof_path": stored_filename,
        "payment_date": payment_date,
    }
```

**ä½ç½®**: ç¬¬ 455-519 è¡Œ

---

#### 2.3 æ·»åŠ è¾…åŠ©å‡½æ•°

**æ–‡ä»¶**: [app.py](file:///c:/Users/zhi89/Desktop/invos/app.py)

**æ–°å¢å‡½æ•°**:
```python
def calculate_payment_status(paid_amount: float, total_amount: float) -> str:
    """è®¡ç®—ä»˜æ¬¾çŠ¶æ€"""
    if paid_amount == 0:
        return 'unpaid'
    elif paid_amount >= total_amount:
        return 'paid'
    else:
        return 'partial'

def calculate_remaining_amount(total_amount: float, paid_amount: float, credit: float) -> float:
    """è®¡ç®—å‰©ä½™åº”ä»˜é‡‘é¢"""
    remaining = total_amount - paid_amount - credit
    return max(0, remaining)  # ç¡®ä¿ä¸ä¸ºè´Ÿæ•°

def get_payment_status_badge(status: str) -> str:
    """è·å–ä»˜æ¬¾çŠ¶æ€å¾½ç«  HTML"""
    badges = {
        'unpaid': '<span class="badge bg-danger">æœªä»˜æ¬¾</span>',
        'partial': '<span class="badge bg-warning">éƒ¨åˆ†ä»˜æ¬¾</span>',
        'paid': '<span class="badge bg-success">å·²ä»˜æ¸…</span>',
    }
    return badges.get(status, '<span class="badge bg-secondary">æœªçŸ¥</span>')

# æ³¨å†Œä¸º Jinja2 è¿‡æ»¤å™¨
app.jinja_env.filters['payment_status_badge'] = get_payment_status_badge
app.jinja_env.filters['calculate_remaining'] = lambda inv: calculate_remaining_amount(
    inv.get('total_amount', 0), 
    inv.get('paid_amount', 0), 
    inv.get('credit', 0)
)
```

**ä½ç½®**: åœ¨ `format_date_english()` å‡½æ•°ä¹‹åæ·»åŠ (ç¬¬ 75 è¡Œé™„è¿‘)

---

#### 2.4 ä¿®æ”¹ `app.py` - ç¼–è¾‘å‘ç¥¨è·¯ç”±

**æ–‡ä»¶**: [app.py](file:///c:/Users/zhi89/Desktop/invos/app.py)

**è·¯ç”±**: `/edit/<invoice_id>` (POST)

**å˜æ›´å†…å®¹**:
```python
@app.route('/edit/<int:invoice_id>', methods=['GET', 'POST'])
def edit_invoice(invoice_id: int):
    if request.method == 'POST':
        # ... ç°æœ‰å­—æ®µè·å– ...
        
        # æ–°å¢: è·å– credit å­—æ®µ
        credit_raw = request.form.get('credit', '0.00')
        try:
            credit = float(credit_raw.replace(',', ''))
            if credit < 0:
                flash("Credit amount cannot be negative.", 'danger')
                return redirect(url_for('edit_invoice', invoice_id=invoice_id))
        except (TypeError, ValueError):
            credit = 0.00
        
        invoice_data = {
            # ... ç°æœ‰å­—æ®µ ...
            "credit": credit,  # æ–°å¢
        }
```

**ä½ç½®**: ç¬¬ 349-407 è¡Œ

---

#### 2.5 ä¿®æ”¹ `app.py` - æ ‡è®°æœªä»˜æ¬¾è·¯ç”±

**æ–‡ä»¶**: [app.py](file:///c:/Users/zhi89/Desktop/invos/app.py)

**è·¯ç”±**: `/mark_unpaid/<invoice_id>` (POST)

**å˜æ›´å†…å®¹**:
```python
@app.route('/mark_unpaid/<int:invoice_id>', methods=['POST'])
def mark_unpaid(invoice_id: int):
    # ... åˆ é™¤ä»˜æ¬¾å‡­è¯é€»è¾‘ ...
    
    update_data = {
        "payment_status": "unpaid",
        "paid_amount": 0.00,  # æ–°å¢: é‡ç½®å·²ä»˜é‡‘é¢
        "payment_proof_path": None,
        "payment_date": None,
    }
```

**ä½ç½®**: ç¬¬ 539-582 è¡Œ

---

### é˜¶æ®µ 3: å‰ç«¯ç•Œé¢å±‚å‡çº§

#### 3.1 ä¿®æ”¹ `templates/upload.html`

**æ–‡ä»¶**: [templates/upload.html](file:///c:/Users/zhi89/Desktop/invos/templates/upload.html)

**æ–°å¢å­—æ®µ**:
```html
<!-- åœ¨ Total Amount å­—æ®µä¹‹åæ·»åŠ  -->
<div class="mb-3">
    <label for="credit" class="form-label">Credit Amount (Optional)</label>
    <input type="number" class="form-control" id="credit" name="credit" 
           step="0.01" min="0" value="0.00" placeholder="0.00">
    <div class="form-text">Enter any credit amount to be deducted from the total.</div>
</div>
```

**ä½ç½®**: åœ¨ Total Amount è¾“å…¥æ¡†ä¹‹å

---

#### 3.2 ä¿®æ”¹ `templates/edit.html`

**æ–‡ä»¶**: [templates/edit.html](file:///c:/Users/zhi89/Desktop/invos/templates/edit.html)

**å˜æ›´ 1: æ˜¾ç¤º Credit å­—æ®µ**
```html
<!-- åœ¨ Total Amount æ˜¾ç¤ºä¹‹åæ·»åŠ  -->
<div class="mb-3">
    <label for="credit" class="form-label">Credit Amount</label>
    <input type="number" class="form-control" id="credit" name="credit" 
           value="{{ invoice.credit }}" step="0.01" min="0">
</div>
```

**å˜æ›´ 2: ä¿®æ”¹ä»˜æ¬¾ç¡®è®¤è¡¨å•**
```html
<form action="{{ url_for('upload_payment_proof', invoice_id=invoice.id) }}" 
      method="POST" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="paymentDate" class="form-label">Payment Date</label>
        <input type="date" class="form-control" id="paymentDate" 
               name="paymentDate" required>
    </div>
    
    <!-- æ–°å¢: Paid Amount è¾“å…¥ -->
    <div class="mb-3">
        <label for="paidAmount" class="form-label">Paid Amount</label>
        <input type="number" class="form-control" id="paidAmount" 
               name="paidAmount" step="0.01" min="0" 
               max="{{ invoice.total_amount - invoice.paid_amount }}" 
               required>
        <div class="form-text">
            Current paid: ${{ "%.2f"|format(invoice.paid_amount) }} / 
            Total: ${{ "%.2f"|format(invoice.total_amount) }}
            {% set remaining = invoice.total_amount - invoice.paid_amount - invoice.credit %}
            <br>Remaining: ${{ "%.2f"|format(remaining) }}
        </div>
    </div>
    
    <div class="mb-3">
        <label for="paymentFile" class="form-label">Payment Proof (Optional)</label>
        <input type="file" class="form-control" id="paymentFile" 
               name="paymentFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>
    
    <button type="submit" class="btn btn-primary">Confirm Payment</button>
</form>
```

**å˜æ›´ 3: æ˜¾ç¤ºä»˜æ¬¾è¿›åº¦**
```html
<!-- åœ¨ä»˜æ¬¾ä¿¡æ¯åŒºåŸŸæ·»åŠ  -->
<div class="card mb-3">
    <div class="card-header">Payment Progress</div>
    <div class="card-body">
        <div class="mb-2">
            <strong>Total Amount:</strong> ${{ "%.2f"|format(invoice.total_amount) }}
        </div>
        <div class="mb-2">
            <strong>Credit:</strong> ${{ "%.2f"|format(invoice.credit) }}
        </div>
        <div class="mb-2">
            <strong>Paid Amount:</strong> ${{ "%.2f"|format(invoice.paid_amount) }}
        </div>
        <div class="mb-2">
            <strong>Remaining:</strong> ${{ "%.2f"|format(invoice|calculate_remaining) }}
        </div>
        <div class="mb-2">
            <strong>Status:</strong> {{ invoice.payment_status|payment_status_badge|safe }}
        </div>
        
        <!-- è¿›åº¦æ¡ -->
        {% set progress = (invoice.paid_amount / invoice.total_amount * 100)|int %}
        <div class="progress">
            <div class="progress-bar 
                {% if progress >= 100 %}bg-success
                {% elif progress > 0 %}bg-warning
                {% else %}bg-danger{% endif %}" 
                role="progressbar" style="width: {{ progress }}%">
                {{ progress }}%
            </div>
        </div>
    </div>
</div>
```

---

#### 3.3 ä¿®æ”¹ `templates/index.html`

**æ–‡ä»¶**: [templates/index.html](file:///c:/Users/zhi89/Desktop/invos/templates/index.html)

**å˜æ›´: æ·»åŠ æ–°åˆ—æ˜¾ç¤º**
```html
<table class="table table-striped">
    <thead>
        <tr>
            <th>Date</th>
            <th>Invoice #</th>
            <th>Company</th>
            <th>Total Amount</th>
            <th>Credit</th>  <!-- æ–°å¢ -->
            <th>Paid</th>  <!-- æ–°å¢ -->
            <th>Remaining</th>  <!-- æ–°å¢ -->
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for invoice in invoices %}
        <tr>
            <td>{{ invoice.invoice_date|format_date }}</td>
            <td>{{ invoice.invoice_number }}</td>
            <td>{{ invoice.company_name }}</td>
            <td>${{ "%.2f"|format(invoice.total_amount) }}</td>
            
            <!-- æ–°å¢: Credit åˆ— -->
            <td>
                {% if invoice.credit > 0 %}
                    <span class="text-success">${{ "%.2f"|format(invoice.credit) }}</span>
                {% else %}
                    -
                {% endif %}
            </td>
            
            <!-- æ–°å¢: Paid åˆ— -->
            <td>${{ "%.2f"|format(invoice.paid_amount) }}</td>
            
            <!-- æ–°å¢: Remaining åˆ— -->
            <td>
                {% set remaining = invoice|calculate_remaining %}
                {% if remaining > 0 %}
                    <span class="text-danger">${{ "%.2f"|format(remaining) }}</span>
                {% else %}
                    <span class="text-success">$0.00</span>
                {% endif %}
            </td>
            
            <!-- ä¿®æ”¹: Status åˆ— -->
            <td>{{ invoice.payment_status|payment_status_badge|safe }}</td>
            
            <td>
                <a href="{{ url_for('edit_invoice', invoice_id=invoice.id) }}" 
                   class="btn btn-sm btn-primary">Edit</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
```

---

## ç®€å•éªŒè¯

### æœ¬åœ°æµ‹è¯•
```bash
# 1. å¯åŠ¨åº”ç”¨
python app.py

# 2. åˆ›å»ºå‘ç¥¨,å¡« Credit = 100
# 3. ä»˜æ¬¾ $300,æ£€æŸ¥çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
```

### Render éƒ¨ç½²
```bash
git add .
git commit -m "feat: add credit and paid_amount"
git push

# ç­‰ 3 åˆ†é’Ÿ,è®¿é—®ç½‘ç«™æµ‹è¯•å³å¯
```

---

## æ³¨æ„äº‹é¡¹

**å…è´¹ Render é™åˆ¶**:
- åº”ç”¨ä¼šä¼‘çœ (æ— æµé‡ 15 åˆ†é’Ÿå)
- é¦–æ¬¡è®¿é—®éœ€è¦ç­‰å¾…å”¤é†’(çº¦ 30 ç§’)
- æ•°æ®åº“è¿ç§»åœ¨å”¤é†’æ—¶è‡ªåŠ¨æ‰§è¡Œ

**å•äººä½¿ç”¨ä¼˜åŒ–**:
- ä¸éœ€è¦å¤æ‚æƒé™æ§åˆ¶
- ä¸éœ€è¦æ€§èƒ½ä¼˜åŒ–
- ä¸éœ€è¦è¯¦ç»†æ—¥å¿—

---

**é¢„è®¡æ—¶é—´**: 3-4 å°æ—¶(å¼€å‘ + æµ‹è¯•)
**ç‰ˆæœ¬**: v1.0 (ç®€åŒ–ç‰ˆ)
