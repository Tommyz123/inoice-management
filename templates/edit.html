{% extends "base.html" %}

{% block title %}Edit Invoice{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1"><i class="fas fa-edit me-2"></i>Edit Invoice</h1>
                    <p class="text-muted mb-0">Update invoice details and information</p>
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Invoice Information</h3>
                </div>
                <form method="post">
                    <div class="card-body">
                        {% if invoice.pdf_path %}
                        <div class="alert alert-info mb-4" style="border-left: 4px solid var(--info-color);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-pdf me-3" style="font-size: 2rem; color: var(--info-color);"></i>
                                <div class="flex-grow-1">
                                    <strong>Current PDF File</strong>
                                    <p class="mb-2 mt-1">A PDF file is attached to this invoice</p>
                                    <a href="{{ url_for('download_invoice', filename=invoice.pdf_path) }}"
                                        class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye me-2"></i>View PDF
                                    </a>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Note: You cannot change the PDF file when editing. To change the file, please delete
                                this invoice and create a new one.
                            </small>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="invoiceDate" class="form-label"><i class="fas fa-calendar me-2"></i>Invoice
                                    Date</label>
                                <input type="date" class="form-control" id="invoiceDate" name="invoiceDate"
                                    value="{{ invoice.invoice_date }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="invoiceNumber" class="form-label"><i class="fas fa-hashtag me-2"></i>Invoice
                                    Number</label>
                                <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber"
                                    value="{{ invoice.invoice_number }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyName" class="form-label"><i class="fas fa-building me-2"></i>Company
                                    Name</label>
                                <input type="text" class="form-control" id="companyName" name="companyName"
                                    value="{{ invoice.company_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="totalAmount" class="form-label"><i class="fas fa-dollar-sign me-2"></i>Total
                                    Amount</label>
                                <input type="text" class="form-control" id="totalAmount" name="totalAmount"
                                    value="{{ invoice.total_amount }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="enteredBy" class="form-label"><i class="fas fa-user me-2"></i>Entered
                                    By</label>
                                <input type="text" class="form-control" id="enteredBy" name="enteredBy"
                                    value="{{ invoice.entered_by }}" required>
                            </div>
                            <div class="col-md-12">
                                <label for="notes" class="form-label"><i class="fas fa-sticky-note me-2"></i>Notes
                                    (Optional)</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3"
                                    placeholder="Add any additional notes here...">{{ invoice.notes or '' }}</textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Invoice
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Payment Information Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-receipt me-2"></i>Payment Information</h3>
                </div>
                <div class="card-body">
                    <!-- Payment History -->
                    {% if payment_history and payment_history|length > 0 %}
                    <div class="mb-4">
                        <h5><i class="fas fa-history me-2"></i>Payment History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="text-end">Amount</th>
                                        <th>Proof</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in payment_history %}
                                    <tr>
                                        <td>{{ record.payment_date }}</td>
                                        <td class="text-end">${{ "{:,.2f}".format(record.payment_amount) }}</td>
                                        <td>
                                            {% if record.payment_proof_path %}
                                            <a href="{{ url_for('download_payment_proof', filename=record.payment_proof_path) }}"
                                                target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-file-pdf"></i> View
                                            </a>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td><small class="text-muted">{{ record.created_at }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-active">
                                        <td><strong>Total Paid</strong></td>
                                        <td class="text-end"><strong>${{
                                                "{:,.2f}".format(invoice.paid_amount|default(0)) }}</strong></td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <hr>
                    </div>
                    {% else %}
                    <!-- No Payment History -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>No payment history yet.</strong> Payment records will appear here after you submit
                        payments.
                    </div>
                    {% endif %}

                    {% if invoice.payment_status == 'paid' %}
                    <!-- Paid Invoice Display -->
                    <div class="alert alert-success mb-4" style="border-left: 4px solid var(--success-color);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-3"
                                style="font-size: 2rem; color: var(--success-color);"></i>
                            <div class="flex-grow-1">
                                <strong>Invoice Marked as PAID</strong>
                                {% if invoice.payment_date %}
                                <p class="mb-0 mt-1">Payment Date: {{ invoice.payment_date|format_date }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if invoice.payment_proof_path %}
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-file-pdf me-2"></i>Payment Proof</label>
                        <div>
                            <a href="{{ url_for('download_payment_proof', filename=invoice.payment_proof_path) }}"
                                class="btn btn-outline-success" target="_blank">
                                <i class="fas fa-eye me-2"></i>View Payment Proof PDF
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Mark as Unpaid Form -->
                    <form method="post" action="{{ url_for('mark_unpaid', invoice_id=invoice.id) }}"
                        onsubmit="return confirm('Are you sure you want to mark this invoice as unpaid? This will remove the payment proof.');">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-undo me-2"></i>Mark as Unpaid
                        </button>
                    </form>

                    {% else %}
                    <!-- Unpaid Invoice - Upload Payment Proof -->
                    <div class="alert alert-warning mb-4" style="border-left: 4px solid var(--warning-color);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock me-3" style="font-size: 2rem; color: var(--warning-color);"></i>
                            <div>
                                <strong>Invoice Status: UNPAID</strong>
                                <p class="mb-0 mt-1">Upload payment proof to mark this invoice as paid</p>
                            </div>
                        </div>
                    </div>

                    <form method="post" action="{{ url_for('upload_payment_proof', invoice_id=invoice.id) }}" <!--
                        Credit Amount -->
                        <div class="mb-4">
                            <label for="credit" class="form-label"><i class="fas fa-gift me-2"></i>Credit Amount <span
                                    class="text-muted">(Optional)</span></label>
                            <input type="number" step="0.01" class="form-control" id="credit" name="credit"
                                value="{{ invoice.credit|default(0.00) }}">
                            <small class="form-text text-muted">Credit from company (e.g., refunds) that can be deducted
                                from remaining amount</small>
                        </div>

                        enctype="multipart/form-data">
                        <!-- Payment Progress -->
                        <div class="mb-4">
                            <label class="form-label"><i class="fas fa-chart-line me-2"></i>Payment Progress</label>
                            <div class="progress" style="height: 25px;">
                                {% set paid_pct = ((invoice.paid_amount|default(0) / invoice.total_amount) *
                                100)|round(1) if invoice.total_amount > 0 else 0 %}
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ paid_pct }}%;"
                                    aria-valuenow="{{ paid_pct }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ paid_pct }}%
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <strong>Paid:</strong> ${{ invoice.paid_amount|default(0)|round(2) }} /
                                <strong>Total:</strong> ${{ invoice.total_amount|round(2) }} |
                                <strong>Remaining:</strong> ${{ (invoice.total_amount - invoice.paid_amount|default(0) -
                                invoice.credit|default(0))|round(2) }}
                            </small>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="paidAmount" class="form-label"><i
                                        class="fas fa-money-bill-wave me-2"></i>Paid Amount <span
                                        class="text-muted">(Optional)</span></label>
                                <input type="number" step="0.01" class="form-control" id="paidAmount" name="paidAmount">
                                <small class="form-text text-muted">Enter the amount you are paying now (leave empty if
                                    only updating credit)</small>
                            </div>
                            <div class="col-md-6">
                                <label for="paymentDate" class="form-label"><i
                                        class="fas fa-calendar-check me-2"></i>Payment Date <span
                                        class="text-muted">(Optional)</span></label>
                                <input type="date" class="form-control" id="paymentDate" name="paymentDate">
                            </div>
                            <div class="col-md-12">
                                <label for="paymentProof" class="form-label"><i
                                        class="fas fa-file-upload me-2"></i>Payment Proof <span
                                        class="text-muted">(Optional)</span></label>
                                <input type="file" class="form-control" id="paymentProof" name="paymentProof"
                                    accept="application/pdf,image/jpeg,image/png,image/tiff">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Optional: Upload a PDF or image file (JPEG, PNG, TIFF) of the payment receipt, bank
                                    transfer confirmation, or other payment proof.
                                </small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle me-2"></i>Submit
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}